<html layout:decorate="~{layout_page}">

<head>
<style>
    .background-yellow {
        background: #ffd800
    }
    .background-skyblue {
        background: #00e0ff
    }
    .background-white {
        background: #ffffff
    }
    table.type01 {
        border-collapse: collapse;
        text-align: left;
        line-height: 1.5;
        margin: 20px 10px;
    }
    table.type01 th {
        width:150px;;
        padding: 10px;
        font-weight: bold;
        vertical-align: middle;
        border: 1px solid #ccc;
        text-align: center;
    }
    table.type01 td {
        width:950px;
        padding: 10px;
        vertical-align: middle;
        border: 1px solid #ccc;
    }
</style>
</head>

<th:block layout:fragment="content">
<div class="content_wrap">

    <input type="hidden" id="hd_id" th:value="${hd_id}" />
    <input type="hidden" id="hp_id" th:value="${hp_id}" />
    <input type="hidden" id="viewMode" th:value="${view_mode}" />
    <input type="hidden" id="apprView" th:value="${appr_view}" />

    <section class="section">    
        <div class="title_box">
            <div class="left_align">
                <h3 data-labelCd="CCP주정첨가일지">CCP주정첨가일지</h3>
            </div>
            <button type="button" class="btn-default pull-right" id="btnHeaderFilter" title="필터 보이기/감추기"><i class="fas fa-filter"></i></button>
            <button type="button" class="btn-default pull-right" id="btnHeaderCompress" title="화면 확대/축소"><i class="fas fa-compress"></i></button>
        </div>
        <div class="table_box search">
        <div class="title_box">
            <button type="button" class="btn-default" id="btnExcel"><i class="fas fa-file-excel"></i></button>
            <button type="button" class="btn-default" id="btnDiaryPrint">일지출력</button>
            <button type="button" class="btn-default" id="btnReqAppr">결재상신</button>
            <button type="button" class="btn-default" id="btnAppr" style="display:none;">승인</button>
            <button type="button" class="btn-cancel" id="btnReject" style="display:none;">반려</button>
            <button type="button" class="btn-default" id="btnSave">일지저장</button>
            <button type="button" class="btn-default" id="btnList">목록</button>
        </div>        
        
            <div class="row">
                <div class="col-6 col-lg-6 col-xl-6">
                    <div class="row">
                        <div class="col-12 col-lg-12 col-xl-12">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_md" data-labelCd="일지명">일지명</span>
                                </div>
                                <input class="form-control2" type="text" id="txtTitle" name="title" value="" readonly />
                            </div>
                        </div>
                        <div class="col-6 col-lg-6 col-xl-6">
                            <div class="input-group" data-ax5picker="basic" id="srchDt">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_md" data-labelCd="일자">일자</span>
                                </div>
                                <input class="form-control2 tac" type="text" id="dataDate" name="dataDate" disabled />
                                <span class="input-group-text fs-xl"><i class="fas fa-calendar-alt calendar_color"></i></span>
                            </div>
                        </div>
                        
                        <div class="col-6 col-lg-6 col-xl-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_md" data-labelCd="HACCP공정">HACCP공정</span>
                                </div>
                                <select class="form-control2" id="cboHaccpProcess" name="hp_id" disabled></select>
                            </div>
                        </div>                        
                        <div class="col-6 col-lg-6 col-xl-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_md" data-labelCd="작성자">작성자</span>
                                </div>
                                <input class="form-control2 tac" type="text" id="txtWriterName" name="WriterName" disabled />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-6 col-xl-6">
                    <div id="approveBox"></div>
                </div>
            </div>

            
        </div>
        <div class="title_box">
            <span class="right_align rpt" data-labelcd="관리기준">관리기준</span>
            <div class="left_align">
                <label class="switch">
                    <input type="checkbox" id="btnToggle" value="" checked><span class="slider round"></span>
                </label>
                관리기준 보기/감추기
            </div>
        </div>
        
        <div id="standardDIv" class="row">
             <div class="col-12">
                 <table class="type01" style="width:99%">
                     <tr>
                         <th scope="row">한계기준</th>
                         <td id="Standard"></td>
                     </tr>
                     <tr>
                         <th scope="row">모니터링방법</th>
                         <td id="MonitoringMethod"></td>
                     </tr>
                     <tr>
                         <th scope="row">개선조치방법</th>
                         <td id="ActionMethod"></td>
                     </tr>
                     
                     <tr>
                         <th scope="row">점검주기</th>
                         <td id="TestCycle"></td>
                     </tr>
                     <tr>
                         <th scope="row">비고</th>
                         <td id="Description"></td>
                     </tr>
                 </table>
             </div>
        </div>
    </section>
        
    <section class="section">

         <div class="row">
             <div class="col-12 col-sm-12 col-md-12 col-lg-3 col-xl-2">
                 <div class="input-group">
                     <div class="input-group-prepend">
                         <span class="input-group-text fit_box_md" data-labelCd="설비">설비</span>
                     </div>
                     <select class="form-control2" id="cboEquipment" name="equ_id"></select>
                 </div>
             </div>
             <div class="col-12 col-sm-12 col-md-12 col-lg-3 col-xl-2">
                 <div class="input-group">
                     <div class="input-group-prepend">
                         <span class="input-group-text fit_box_md" data-labelCd="측정구분">측정구분</span>
                     </div>
                     <select class="form-control2" id="cboDataType" name="DataType">
                         <option value="S">작업시작 전</option>
                         <option value="P">제품</option>
                         <option value="E">작업종료 후</option>
                     </select>
                 </div>
             </div>
             <div class="col-12 col-sm-12 col-md-12 col-lg-3 col-xl-2">
                 <div class="input-group">
                     <div class="input-group-prepend">
                         <span class="input-group-text fit_box_md" data-labelCd="측정시간">측정시간</span>
                     </div>
                     <input class="form-control2" type="text" id="StartTime" name="StartTime" placeholder="00:00" value="00:00" />
                 </div>
             </div>
             <div class="col-12 col-sm-12 col-md-12 col-lg-3 col-xl-3">
                 <div class="input-group">
                     <div class="input-group-prepend">
                         <span class="input-group-text fit_box_md" data-labelCd="제품선택">제품선택</span>
                     </div>
                     <select class="form-control2" id="cboMaterialGroup" name="MaterialGroup_id"></select>
                     <select class="form-control2" id="cboMaterial" name="Material_id"><option value="">선택</select>&nbsp;

                 </div>
             </div>
             <div class="col-12 col-sm-12 col-md-6 col-lg-5 col-xl-3">
                 <div class="input-group">
                     <button type="button" class="btn-default" id="btnAddTestItems"><i class="fas fa-plus"></i><span>검사결과추가</span></button>&nbsp;
                     <button type="button" class="btn-default" id="btnSaveItems"><i class="fas fa-save"></i><span>변경저장</span></button>&nbsp;
                     <button type="button" class="btn-danger" id="btnDeleteItem"><i class="fas fa-trash"></i><span>행 삭제</span></button>
                 </div>
             </div>
             <div class="col-12">
                 <div class="grid_box">
                     <div class="h-300" data-ax5grid="haccp-test-grid"></div>
                 </div>
             </div>
         </div>
    </section>

  <section>
        <div class="title_box">
            <span class="right_align rpt" data-labelCd="이탈발생현황">이탈발생현황</span>
        </div>
        <div class="table_box sub">
            <form id="detectForm">
                <div class="row">
                    <div class="col-3 col-sm-12 col-md-6 col-lg-5 col-xl-5">
                        <div class="input-group">
                            <button type="button" class="btn-danger" id="btnDeleteDetect" disabled><i class="fas fa-trash"></i><span>행 삭제</span></button>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="grid_box">
                            <div class="h-230" data-ax5grid="haccp-detect-grid"></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>
</th:block>

<th:block layout:fragment="scripts">
<th:block th:replace="/haccp/common/pop_haccp_devi_detect :: pop_devi_detect"></th:block>
<th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
<th:block th:replace="/common/approve_box :: approve_box"></th:block>

<script type="text/javascript" src="/js/grid.js"></script>
<script type="text/javascript">
class HaccpDiaryPage {
    constructor() {
        this.url = '/api/haccp/diary';
        this.taskCode = 'CCP주정첨가일지';
        this.hp_id = 13;
        
        this.parent_code = 'haccp_add_ethanol_devi_action';

        this.grid = null;
        this.hd_id=null;
        this.view_mode = true;
        this.diary = null;
        
        this.$dataDate = null;
        this.$cboHaccpProcess = null;
        this.$txtWriterName = null;
        
        // 이 화면에서는 bundle_head, dept_id, shift를 사용하지 않는다.
        this.head_id = null; 
        this.dept_id = null;
        this.shift = "";

        this.process_items = [];
        this.dicDataType = {'S':'작업시작 전', 'P':'제품','E':'작업종료 후'};
        
        this.init();
    }

    init() {
        let _this = this;

        // 일지 데이터 PK 설정
        this.hd_id = $('#hd_id').val()
        this.hp_id = $('#hp_id').val();
        let viewMode = $('#viewMode').val();

        this.view_mode = viewMode=="true"? true:false;

        // 일자
        this.$dataDate = $('#dataDate');
        this.$dataDate.ax5DatePicker({ direction: 'top' });
        if (this.hd_id=="0" || this.hd_id==""){
            this.$dataDate.val(CommonUtil.getYYYYMMDD());
        }

        // 일지명
        $('#txtTitle').val(this.taskCode);
        
        // HACCP가열공정
        this.$cboHaccpProcess = $('#cboHaccpProcess');
        AjaxUtil.fillSelectOptions(this.$cboHaccpProcess, 'haccp_process', 'choose', this.hp_id);

        // 작성자
        this.$txtWriterName = $('#txtWriterName');
        
        // 동기처리
        this.loadHaccpProcessDetail(this.hp_id);

        // 결재정보 설정
        this.loadApprData();

        // 이탈검출
        this.initDetectList();

        // 일지 데이터 로드
        this.loadDiaryData();

    }

    // haccp_test 그리드 초기화
    initHaccpTestGrid(){
        let _this = this;
        
        let cols = [];
        let editor_ox = {
            type: 'select',
            config: {
                columnKeys: {
                    optionValue: "value", optionText: "text"
                },
                options: [{ value: 'O', text: 'O' }, { value: "X", text: "X" }]
            }
        };
        cols.push({ key: 'equ_name', label: '설비명', width: 150, sortable: false, align: 'left' });
        cols.push({ key: 'mat_code', label: '제품코드', width: 120, sortable: false, align: 'left' });
        cols.push({ key: 'MaterialName', label: '제품명', width: 250, sortable: false, align: 'left' });
        cols.push({ key: 'DataType', label: '측정구분', width: 100, sortable: false, align: 'center', formatter: function () { return _this.dicDataType[this.value] },});
        cols.push({ key: 'StartTime', label: '<span class="editable_clr">측정시간</span>', width: 100, align: 'center', sortable: false, editor: { type: 'text' } });
        $.each(_this.process_items, function (idx, r) {
            let kv = 'item_' + r.item_id;
            let label = '<span class="editable_clr">' + r.item_name + "</span>";
            let c = {};
            // ResultType==OX 이면
            if (r.ResultType == 'OX') {
                c = {
                    key: kv, label: label, width: 120, align: 'center', editor: editor_ox, sortable: false,
                    formatter: function () {
                        let ret = this.value;
                        if (ret == null) {
                            ret = '-';
                        }
                        return ret;
                    }
                };
            }
            else if(r.ResultType == 'text'){
                c = { key: kv, label: label, width: 120, align: 'right', editor: { type: 'text' }, sortable: false };
            }else{
                c = { key: kv, label: label, width: 120, align: 'right', editor: { type: 'number' }, sortable: false };
            }
            cols.push(c);
        });
        cols.push({
            key: 'Judge', label: '<span class="editable_clr">판정(적합:O/부적합:X)</span>', width: 150, align: 'center', sortable: false, 
            formatter: function () {
                let ret = this.value;
                if (ret == null) {
                    ret = '-';
                }
                return ret;
            }
        });
        cols.push({ key: 'TesterName', label: '<span class="editable_clr">모니터링 담당자</span>', width: 120, align: 'center', sortable: false, editor: { type: 'text' } });
        cols.push({ key: 'Description', label: '<span class="editable_clr">비고</span>', width: 260, sortable: false, editor: { type: 'text' }, align: 'left'  });

        let config = {
            target: $('[data-ax5grid="haccp-test-grid"]'),
            sortable: true,
            frozenColumnIndex: 0, // 열 고정
            frozenRowIndex: 0,    // 행 고정
            showLineNumber: true, // 열의 번호 보이기 여부
            showRowSelector: false,  // checkbox(선택) 보이기 여부
            multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
            sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
            multiSort: true, // 다중 정렬 여부
            header: {
                align: 'center',  // 헤더의 기본 정렬
                columnHeight: 30  // 헤더 높이
            },
            body: {
                columnHeight: 25,
                onClick: function (e) {
                    e.self.select(this.dindex);
                    if(e.column.key == 'Judge' && _this.view_mode==false){
                        e.item.__modified__ = true;
                        if (e.item.Judge == null || e.item.Judge == 'null') {
                            e.item.Judge = "O";
                            e.self.repaint();
                        }
                        else if (e.item.Judge == 'O') {
                            e.item.Judge = 'X';
                            e.self.repaint();
                        }
                        else if (e.item.Judge == 'X') {
                            e.item.Judge = "O";
                            e.self.repaint();
                        }
                    }
                },
                onDataChanged: function () {
					if(this.key == 'StartTime') {
						let ret = this
						DataValidation.validateTime(ret)
						this.item.StartTime = ret.value
						return this.item.StartTime
					}                        
              }
            },
            page: {
                display: true,
                statusDisplay: true,
            },
            columns: cols
        };
        this.haccpTestGrid = new ax5.ui.grid(config);

        // 목록버튼
        this.$btnList = $('#btnList');
        this.$btnList.click(function(e){
            let url = '/gui/'+gui.gui_code;
            location.href = url;
        });

        // 출력버튼
        this.$btnDiaryPrint = $('#btnDiaryPrint');
        this.$btnDiaryPrint.click(function (e) {
            let url = "/api/files/haccp_diary?action=haccp_diary_download&diary_id=" + _this.hd_id;
            //let url = "/api/files/haccp_diary?action=haccp_diary_simple&diary_id=" + _this.hd_id;
            window.open(url, '_new', '');
        });

        //결재 상신
        this.$btnReqAppr = $('#btnReqAppr');
        this.$btnReqAppr.click(function(e){
            Alert.confirm('결재상신', '상신하시겠습니까?', function(){
            	_this.reqAppr();
           	});
        });
        
        
        //승인
        this.$btnAppr = $('#btnAppr');
        this.$btnAppr.click(function(e){
            _this.appr(true);
        });
        
        
        //반려
        this.$btnReject = $('#btnReject');
        this.$btnReject.click(function () {
            _this.appr(false);
        });        

        //일지저장
        this.$btnSave = $('#btnSave');
        this.$btnSave.click(function(e){
            _this.saveDiary();
        });

        // 하위 결과입력란시작
        this.$cboEquipment = $('#cboEquipment'); //설비
        this.$cboDataType = $('#cboDataType'); //테스트구분
        this.$cboMaterialGroup = $('#cboMaterialGroup'); // 제품그풉
        this.$cboMaterial = $('#cboMaterial'); //제품
        this.$StartTime = $('#StartTime');

        this.$btnAddTestItems = $('#btnAddTestItems'); //검사결과추가버튼
        this.$btnSaveItems = $('#btnSaveItems'); //변경저장
        this.$btnDeleteItem = $('#btnDeleteItem');  // 행삭제
        this.$btnAddTestItems.click(function (e) {
            _this.addTestItems();
        });
        
        
        this.$btnSaveItems.click(function(e){
        	let testItems = _this.haccpTestGrid.getList('modified');
            let modifiedCount = testItems.length;
            if (modifiedCount > 0) {
                Alert.confirm('항목저장', '항목을 저장하시겠습니까?', function () {
                    // 저장함수 호출
                    _this.saveHaccpTestItems(testItems);
                });
            } else {
                Alert.alert('항목저장', '변경된 데이터가 없습니다.');
            }
        });
        
        this.$btnDeleteItem.click(function(e){
            let items = _this.haccpTestGrid.getList('selected');
            if (items.length == 0) {
                Alert.alert('항목삭제', '선택된 행이 없습니다.');
                return;
            }
            Alert.confirm('항목삭제', '선택한 행을 삭제하시겠습니까?', function () {
                _this.deleteHaccpTest(items);
            });
        });
        

        AjaxUtil.fillSelectOptions(this.$cboEquipment, 'equipment', 'choose', false);
        
        this.$cboMaterialGroup = $('#cboMaterialGroup');
        AjaxUtil.fillSelectOptions(this.$cboMaterialGroup, 'material_group', 'choose', false, 'product');
        
        this.$cboMaterial = $('#cboMaterial');
        this.$cboMaterialGroup.change(function(e){
            let mat_grp_id = _this.$cboMaterialGroup.val();
            AjaxUtil.fillSelectOptions(_this.$cboMaterial, 'material', 'choose', false, mat_grp_id);
        });
        
        // 데이터 구분에 따라 입력 제한
        this.$cboDataType.change(function (e) {
            let DataType = _this.$cboDataType.val();

            if (DataType == "P") {
                _this.$cboMaterialGroup.removeAttr('disabled');
                _this.$cboMaterial.removeAttr('disabled');
            }
            else {
                _this.$cboMaterialGroup.attr('disabled', 'disabled');
                _this.$cboMaterial.attr('disabled', 'disabled');
                _this.$cboMaterialGroup.val('');
                _this.$cboMaterial.val('');
            }
        });
    }

    deleteHaccpTest(items) {
        let _this = this;
        
        let ht_item = items[0];
        let ht_id = ht_item.ht_id;

        let url = this.url + "/delete_haccp_test";
        let data = { ht_id: ht_id };
        let fnsuccess = function (result) {
            if (result.success) {
                Notify.success('삭제되었습니다.');
                _this.showDiaryItemList();
            }
        };

        AjaxUtil.postAsyncData(url, data, fnsuccess);
    }
    

    initDetectList(){
        let _this = this;
        
        

        this.$btnDeleteDetect = $('#btnDeleteDetect');
        
        let config = {
            target: $('[data-ax5grid="haccp-detect-grid"]'),
            sortable: true,
            frozenColumnIndex: 0, // 열 고정
            frozenRowIndex: 0,    // 행 고정
            showLineNumber: true, // 열의 번호 보이기 여부
            showRowSelector: false,  // checkbox(선택) 보이기 여부
            multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
            sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
            multiSort: true, // 다중 정렬 여부
            header: {
                align: 'center',  // 헤더의 기본 정렬
                columnHeight: 30  // 헤더 높이
            },
            body: {
                columnHeight: 25,
                onClick: function (e) {
                	if(_this.view_mode==false){
                        e.self.select(this.dindex);
                        _this.$btnDeleteDetect.removeAttr('disabled');
                	}
                	
                	if(e.column.key == 'AbnormalDetail' && _this.view_mode==false){
                		_this.showDeviActionCodeSavePopup(e.item);
                	}
                	
                },
            },
            page: {
                display: true,
                statusDisplay: true,
            },
            columns: [
            	{ key: 'equ_name', label: '설비명', width: 150, sortable: false, align: 'left'},
            	{ key: 'mat_code', label: '제품코드', width: 100, sortable: false, align: 'center' },
                { key: 'MaterialName', label: '제품명', width: 300, sortable: false, align: 'left'},
                { key: 'StartTime', label: '측정시간', width: 80, sortable: false, editor: { type: 'text' }, align: 'center'},
                { key: 'AbnormalDetail', label: '<span class="editable_clr">이탈사항(클릭)</span>', width: 250, sortable: false },
                { key: 'ActionDetail', label: '조치내역', width: 250, sortable: false, align: 'left' },
                { key: 'ActorName', label: '조치자', width: 80, sortable: false, align: 'center' },
                { key: 'writer', label: '확인자', width: 80, sortable: false, align: 'center' },
                { key: 'description', label: '비고', width: 250, sortable: false, align: 'left' },
            ]
        };
        this.detectGrid = new ax5.ui.grid(config);
        


        // 행 삭제
        this.$btnDeleteDetect.click(function (e) {
            let items = _this.detectGrid.getList('selected');
            if (items.length == 0) {
                Alert.alert('이탈 항목 삭제', '선택된 데이터가 없습니다.');
                return;
            }
            Alert.confirm('이탈 항목 삭제', '삭제하시겠습니까?', function () {
                _this.deleteDetectItem(items[0]);
            });
        });
    }
    
    // haccp공정별 데이터 가져옴
    loadHaccpProcessDetail(hp_id){
        let _this = this;
        let param = {hp_id:this.hp_id};
        let url = "/api/haccp/haccp_process/detail_haccp_process";
        let result = AjaxUtil.getSyncData(url, param);
        if(result.success){
            let data = result.data;
            data.Standard = data.Standard==null?"":data.Standard.replace(/\r?\n|\r/g, "<br>");
            $('#Standard').html(data.Standard);
            data.MonitoringMethod= data.MonitoringMethod==null?"": data.MonitoringMethod.replace(/\r?\n|\r/g, "<br>");
            $('#MonitoringMethod').html(data.MonitoringMethod);
            data.ActionMethod = data.ActionMethod==null?"":data.ActionMethod.replace(/\r?\n|\r/g, "<br>");
            $('#ActionMethod').html(data.ActionMethod);
            $('#TestCycle').html(data.TestCycle);
            $('#Description').html(data.Description);

            _this.process_items = data.haccpProcessItems;
            _this.initHaccpTestGrid();
        }
        else{
            this.process_items = [];
        }
    }

    // 결재정보 읽어오기
    loadApprData(){
        let _this = this;
        
        //constructor(head_id, task_code, src_data_pk, src_table_name, dept_id, shift) {
        this.approveBoxUtil = new ApproveBoxUtil(this.head_id, this.taskCode, this.hd_id, 'haccp_diary', false, false);
        this.approveBoxUtil.print(this.view_mode);
    }

    // 일지데이터 가져오기
    loadDiaryData(){
        let _this = this;
        
        if(this.hd_id=="0" || this.hd_id==""){
            this.$txtWriterName.val(userinfo.username);
            this.$dataDate.removeAttr("disabled");
         // 신규 작성이면 데이터 로드 필요없음
            return;
        }

        let fnsuccess = function(result){
            if(result.success){
                _this.diary = result.data;
                _this.$dataDate.val(result.data.DataDate);
                _this.$txtWriterName.val(result.data.WriterName);

                //테스트결과그리드
                _this.showDiaryItemList();
                _this.showDetectList();
                
                // this.view_mode에 따라 입력활성/비활성
                _this.setApplyMode();

            }
            else{
                Alert.alert('상세오류')
            }
        };

        let url = this.url+'/detail';
        let param = {hd_id : this.hd_id};
        AjaxUtil.getAsyncData(url, param, fnsuccess);
    }

    saveDiary(){
        let _this = this;
        let url = this.url + '/save';
        let param = {
            hd_id : this.hd_id,
            hp_id: this.hp_id,
            data_date : this.$dataDate.val()
        };
        Alert.confirm('일지저장', '저장하시겠습니까?', function(){

            let fnsuccess = function(result){
                if(result.success){
                    _this.hd_id = result.data.id;
                    $('#hd_id').val(_this.hd_id);
                    _this.$dataDate.val(result.data.dataDate);
                    
                    Notify.success("저장되었습니다.");
                }
                else{
                    Alert.alert('저장오류', result.message);
                }
            };
            AjaxUtil.postAsyncData(url, param, fnsuccess);
        });
    }


    
    addTestItems() {
        let _this = this;
        
        if(this.hd_id=="0"){
        	Alert.alert('알림', "일지를 먼저 저장후 결과를 입력하세요");
        	return;
        }

        let material_id = this.$cboMaterial.val();
        let startTime = this.$StartTime.val();
        let dataType = this.$cboDataType.val();
        let equipment_id = this.$cboEquipment.val();
        
        let haccp_grid = _this.haccpTestGrid.getList();
        if(equipment_id==""){
            Alert.alert('입력오류', '설비를 선택해 주세요.');
            return;
        }
        
        if (haccp_grid.length == 0 && dataType != "S") {
            Alert.alert('입력오류', '작업시작 전 데이터를 입력해주세요.');
            return;
        }

        if (haccp_grid.length > 0 && dataType == "S") {
            Alert.alert('입력오류', '작업시작 전 데이터를 입력하실수 없습니다.');
            return;
        }

        if (dataType == "P" && material_id == "") {
            Alert.alert('입력오류', '제품을 선택하세요.');
            return;
        }

        if (this.checkTimeFormat(startTime) == false) {
            Alert.alert('입력오류', '측정시간 입력 오류');
            return;
        }
        if (haccp_grid.length > 0) {
            if (haccp_grid[haccp_grid.length - 1].DataType == "S"&&dataType == "E") {
                Alert.alert('입력오류', '제품데이터를 입력하세요.');
                return;
            }
            if (haccp_grid[haccp_grid.length - 1].dataType == "E") {
                Alert.alert('입력오류', '작업종료 후 데이터가 입력되어있습니다.');
                return;
            }
            if (haccp_grid[haccp_grid.length - 1].startTime >= StartTime) {
                Alert.alert('입력오류', '측정시간 입력 오류\n이전에 입력한 내용이후의 시간으로 입력해주세요.');
                return;
            }
        }
        
        let url = this.url + "/save_haccp_test";
        let data = {
            'hd_id': this.hd_id,
            'hp_id': this.hp_id,
            'equipment_id': equipment_id,
            'material_id': material_id,
            'start_time': startTime,
            'data_type': dataType
        };
        
        let fnsuccess = function (result) {
            if (result.success) {
                Notify.success("항목이 추가되었습니다.");
                _this.showDiaryItemList();
                //let time = new Date(_this.$StartTime.val())
                //time = time.setMinutes(time.getMinutes() + 1)
                //_this.$StartTime.val(time)
            } else {
                Alert.alert('', result.message);
            }
        };
        AjaxUtil.postAsyncData(url, data, fnsuccess);
    }
    
    extractItems(row) {
        let _this = this;
        let haccp_items = [];
        $.each(_this.process_items, function (idx, pi) {
            let key = "item_" + pi.item_id;
            let value = row[key];
            let r = {
                item_id: pi.item_id,
                NumResult: value
            };
            haccp_items.push(r);
        });
        return haccp_items;
    }    
    saveHaccpTestItems(haccpTestItems) {
        let _this = this;
        let rows = [];
        $.each(haccpTestItems, function (idx, row) {
            let haccp_items = _this.extractItems(row);
            let r = {
                ht_id: row.ht_id,
                StartTime: row.StartTime,
                Material_id: row.Material_id,
                Judge: row.Judge,
                Description: row.Description,
                TesterName: row.TesterName,
                items: haccp_items
            };
            rows.push(r);
        });

        let strRows = JSON.stringify(rows);
        let data = {
            hd_id: this.hd_id,
            Q: strRows
        };

        let callback = function (res) {
            if (res.success) {
                Notify.success('항목을 저장했습니다.');
                _this.showDiaryItemList();
                _this.showDetectList();
            }
        };
        
        let url = this.url + '/save_haccp_test_item_result';
        AjaxUtil.postAsyncData(url, data, callback);
    }
    
    // 상세항목 목록 조회
    showDiaryItemList() {
        let _this = this;
        let hd_id = this.hd_id;
        let data = {
            hd_id: hd_id
        };

        let fnsuccess = function (result) {
            let dic_haccp_test = {};
            let items = [];
            
            if(result.success){
                $.each(result.data, function (idx, r) {
                    //부모의 경우
                    if (r.item_id == null) {
                        items.push(r);
                        dic_haccp_test[r.ht_id] = r
                    }
                    else {
                        let item = dic_haccp_test[r.ht_id]
                        let k = 'item_' + r.item_id;
                        item[k] = r.NumResult;
                    }
                });
            }
            else{
            	
            }

            _this.haccp_test_items = items
            _this.haccpTestGrid.setData(items);

        };

        let url = this.url + '/test_item_result_list';
        AjaxUtil.getAsyncData(url, data, fnsuccess);
    }


    checkTimeFormat(hhmm) {
        let isValid = /^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(hhmm);
        return isValid;
    }

    // 이탈 발생 목록 행 삭제
    deleteDetectItem(item) {
        let _this = this;
        let fnsuccess = function (result) {
            if (result.success) {
                Notify.success("삭제되었습니다.");
                _this.showDetectList();
            }
        };

        let url = this.url + "/delete_haccp_devi_detect";
        let data = { hddd_id: item.hddd_id };
        AjaxUtil.postAsyncData(url, data, fnsuccess);
    }

    showDetectList() {
        let _this = this;
        let data = {
            hd_id: this.hd_id,
        };

        let fnsuccess = function (result) {
        	if(result.success){
                _this.detectGrid.setData(result.data);
        	}
        	else{
        		_this.detectGrid.setData([]);
        	}
        };

        let url = this.url + "/haccp_devi_detect_list";
        AjaxUtil.getAsyncData(url, data, fnsuccess);
        _this.$btnDeleteDetect.attr('disabled', 'disabled');
    }
    
    showDeviActionCodeSavePopup(detectItem){
        let _this = this;

        let deviDetectPage = new PopupHaccpDeviDetect();
        deviDetectPage.parent_code = this.parent_code;
        deviDetectPage.hddd_id = detectItem.hddd_id;
        
        let fncallback = function(item){
            _this.showDetectList();
        };
        deviDetectPage.show(fncallback);
    }

    setApplyMode(){
    	let _this = this;
    	
        // 읽기모드 일 경우
        if(this.view_mode){
             this.$btnAddTestItems.attr('disabled', 'disabled');
             this.$btnSaveItems.attr('disabled', 'disabled');
             this.$btnDeleteItem.attr('disabled', 'disabled');
             
             if (_this.diary.State == 'approval') {
                 $('#btnDiaryPrint').show();
             }
             $('#btnDelete').hide();
             $('#btnReqAppr').hide();
             $('#btnSave').hide();
        }
        else{
            if (this.diary.State == 'process' || this.diary.State == 'reprocess') {
                $('#btnReqAppr').hide();
                $('#btnSave').hide();
                $('#btnDelete').hide();
            } else if (this.diary.State == 'approval') {
                $('#btnDiaryPrint').show();
                $('#btnReqAppr').hide();
                $('#btnSave').hide();
                $('#btnDelete').hide();
            }
        }
        
        if (_this.approveBoxUtil.isApprUser()) {
            // 결재자의 경우 버튼 처리
            $('#btnAppr').show();
            $('#btnReject').show();
        }
        
    } 
    
    reqAppr() {
        let _this = this;
        let title = $('#title').val();
        let url = '/gui/' + gui.gui_code + '/edit';
        
        let urlParam = {
            'hd_id': this.hd_id,
            'hp_id' : this.hp_id,
            'data_date': this.$dataDate.val(),
        };

        let ret = _this.approveBoxUtil.request(this.hd_id, this.taskCode, url, JSON.stringify(urlParam));
        if (ret.success) {
            Notify.success('결재상신하였습니다.');
            
            _this.$btnReqAppr.hide();
            //$('#btnList').click();
        }
    }

    //결재 : true, 반려 : false
    appr(isAppr) {
        let _this = this;
        _this.approveBoxUtil.approval(isAppr, function () {
            $('#btnList').click();
        });
    }
    

}

$(document).ready(function (e) {
    let page = new HaccpDiaryPage();
    // 그리드 토글
    $('#btnToggle').click(function (e) {
        $("#standardDIv").toggle(300);
    });
    
    $('#StartTime').timepicker({
        show2400: true,
        timeFormat: 'H:i'
    }).val();
    
});
</script>
</th:block>
</html>